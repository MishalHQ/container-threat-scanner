"""
Vulnerability scanning using Trivy
"""

import logging
import json
from pathlib import Path
from collections import defaultdict
from .utils import run_command, ensure_reports_directory, sanitize_image_name


class VulnerabilityScanner:
    """
    Scans container images for vulnerabilities using Trivy
    """
    
    def __init__(self, image_name):
        """
        Initialize vulnerability scanner
        
        Args:
            image_name (str): Docker image name/tag
        """
        self.image_name = image_name
        self.logger = logging.getLogger(__name__)
        self.vuln_data = None
        self.vuln_path = None
    
    def scan(self):
        """
        Scan image for vulnerabilities using Trivy
        
        Returns:
            dict: Vulnerability scan results
        """
        self.logger.info(f"Scanning for vulnerabilities: {self.image_name}")
        
        try:
            # Ensure reports directory exists
            reports_dir = ensure_reports_directory()
            
            # Generate output filename
            safe_name = sanitize_image_name(self.image_name)
            self.vuln_path = reports_dir / f"vuln_{safe_name}.json"
            
            # Run Trivy
            result = run_command([
                'trivy', 'image',
                '--format', 'json',
                '--quiet',
                self.image_name
            ])
            
            # Parse and save vulnerability data
            self.vuln_data = json.loads(result.stdout)
            
            with open(self.vuln_path, 'w') as f:
                json.dump(self.vuln_data, f, indent=2)
            
            self.logger.info(f"âœ“ Vulnerability report saved to: {self.vuln_path}")
            
            return self.vuln_data
            
        except Exception as e:
            self.logger.error(f"Failed to scan vulnerabilities: {str(e)}")
            raise
    
    def get_vulnerability_summary(self):
        """
        Get summary of vulnerabilities by severity
        
        Returns:
            dict: Vulnerability counts by severity
        """
        if not self.vuln_data:
            return {}
        
        severity_counts = defaultdict(int)
        total = 0
        
        results = self.vuln_data.get('Results', [])
        
        for result in results:
            vulnerabilities = result.get('Vulnerabilities', [])
            if not vulnerabilities:
                continue
            
            for vuln in vulnerabilities:
                severity = vuln.get('Severity', 'UNKNOWN')
                severity_counts[severity] += 1
                total += 1
        
        return {
            'total': total,
            'CRITICAL': severity_counts.get('CRITICAL', 0),
            'HIGH': severity_counts.get('HIGH', 0),
            'MEDIUM': severity_counts.get('MEDIUM', 0),
            'LOW': severity_counts.get('LOW', 0),
            'UNKNOWN': severity_counts.get('UNKNOWN', 0)
        }
    
    def get_vulnerable_packages(self):
        """
        Get list of vulnerable packages with details
        
        Returns:
            list: Vulnerable package information
        """
        if not self.vuln_data:
            return []
        
        vulnerable_packages = []
        results = self.vuln_data.get('Results', [])
        
        for result in results:
            target = result.get('Target', '')
            vulnerabilities = result.get('Vulnerabilities', [])
            
            if not vulnerabilities:
                continue
            
            for vuln in vulnerabilities:
                vulnerable_packages.append({
                    'target': target,
                    'package': vuln.get('PkgName'),
                    'installed_version': vuln.get('InstalledVersion'),
                    'fixed_version': vuln.get('FixedVersion'),
                    'vulnerability_id': vuln.get('VulnerabilityID'),
                    'severity': vuln.get('Severity'),
                    'title': vuln.get('Title', ''),
                    'description': vuln.get('Description', '')[:200]  # Truncate
                })
        
        return vulnerable_packages
    
    def classify_vulnerabilities_by_layer(self, layer_analyzer):
        """
        Classify vulnerabilities as base or application layer
        
        Args:
            layer_analyzer: LayerAnalyzer instance
            
        Returns:
            dict: Classified vulnerabilities
        """
        vulnerable_packages = self.get_vulnerable_packages()
        
        base_vulns = []
        app_vulns = []
        
        # Get base and app layers
        base_layers = layer_analyzer.get_base_layers()
        app_layers = layer_analyzer.get_application_layers()
        
        # Simple heuristic: classify based on package type and common patterns
        for vuln in vulnerable_packages:
            package_name = vuln['package'].lower()
            target = vuln['target'].lower()
            
            # Common base image packages
            is_base = any([
                'lib' in package_name,
                'openssl' in package_name,
                'glibc' in package_name,
                'systemd' in package_name,
                'os-release' in target,
                'dpkg' in target,
                'rpm' in target
            ])
            
            if is_base:
                base_vulns.append(vuln)
            else:
                app_vulns.append(vuln)
        
        return {
            'base_layer': base_vulns,
            'application_layer': app_vulns,
            'base_count': len(base_vulns),
            'app_count': len(app_vulns)
        }
    
    def has_critical_vulnerabilities(self):
        """
        Check if image has critical vulnerabilities
        
        Returns:
            bool: True if critical vulnerabilities exist
        """
        summary = self.get_vulnerability_summary()
        return summary.get('CRITICAL', 0) > 0